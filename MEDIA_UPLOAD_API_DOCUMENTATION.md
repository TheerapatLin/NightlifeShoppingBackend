# Media Upload & Processing API Documentation

## Overview
ระบบ Media Upload สำหรับ Chat ที่รองรับการอัพโลดไฟล์ภาพ, วิดีโอ, เสียง และไฟล์ทั่วไป พร้อมระบบ Queue สำหรับ Background Processing

## Features
- ✅ **Multi-file Upload**: รองรับการอัพโลดหลายไฟล์พร้อมกัน (สูงสุด 10 ไฟล์)
- ✅ **OSS Storage**: เก็บไฟล์ใน Alibaba Cloud OSS
- ✅ **Queue Processing**: ใช้ Bull Queue สำหรับ background processing
- ✅ **File Validation**: ตรวจสอบประเภทและขนาดไฟล์
- ✅ **Media Management**: จัดการไฟล์ในห้องแชท
- ✅ **Storage Statistics**: สถิติการใช้งาน storage
- ✅ **Auto Cleanup**: ลบไฟล์ชั่วคราวอัตโนมัติ

---

## Supported File Types

### 📷 Images
- **Formats**: JPEG, PNG, GIF, WebP
- **Max Size**: 10MB per file
- **Processing**: Auto-resize (thumbnail, medium, large)
- **MIME Types**: `image/jpeg`, `image/png`, `image/gif`, `image/webp`

### 🎬 Videos  
- **Formats**: MP4, QuickTime, AVI
- **Max Size**: 100MB per file
- **Processing**: Thumbnail generation, compression (>50MB)
- **MIME Types**: `video/mp4`, `video/quicktime`, `video/x-msvideo`

### 🎵 Audio
- **Formats**: MP3, WAV, OGG
- **Max Size**: 50MB per file
- **Processing**: Metadata extraction
- **MIME Types**: `audio/mpeg`, `audio/wav`, `audio/ogg`

### 📄 Files
- **Formats**: PDF, TXT, DOC, etc.
- **Max Size**: 25MB per file
- **MIME Types**: `application/pdf`, `text/plain`

---

## API Endpoints

### 📤 Upload Media

#### Send Message with Files
```http
POST /api/v1/chat/messages
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**Request Body:**
```javascript
// Form Data
{
  "chatRoomId": "chatRoomId123",
  "content": "Check out these photos!", // Optional text
  "files": [File1, File2, File3] // Array of files (max 10)
}
```

**Response:**
```json
{
  "success": true,
  "message": {
    "_id": "messageId123",
    "chatRoom": "chatRoomId123",
    "sender": {
      "_id": "userId123",
      "name": "John Doe"
    },
    "type": "image", // or "video", "audio", "file"
    "content": "Check out these photos!",
    "mediaInfo": {
      "originalName": "photo.jpg",
      "mimeType": "image/jpeg",
      "size": 1024000,
      "url": "https://oss.example.com/chat-media/...",
      "fileName": "chat-media/roomId/timestamp-randomId-0.jpg",
      "dimensions": { "width": 1920, "height": 1080 },
      "thumbnail": null, // Will be generated by queue
      "uploadedAt": "2024-01-01T12:00:00.000Z"
    },
    "timestamp": "2024-01-01T12:00:00.000Z",
    "status": "sent"
  }
}
```

**Multiple Files Response:**
```json
{
  "success": true,
  "message": {
    "_id": "messageId123",
    "type": "file",
    "content": "3 files",
    "mediaInfo": [
      {
        "originalName": "photo1.jpg",
        "mimeType": "image/jpeg",
        "url": "https://oss.example.com/...",
        // ... other properties
      },
      {
        "originalName": "video1.mp4", 
        "mimeType": "video/mp4",
        "url": "https://oss.example.com/...",
        // ... other properties
      }
    ]
  }
}
```

### 📋 Media Management

#### Get Media in Chat Room
```http
GET /api/v1/chat/rooms/:chatRoomId/media?type=image&page=1&limit=20
Authorization: Bearer <token>
```

**Query Parameters:**
- `type` (optional): Filter by media type (`image`, `video`, `audio`, `file`)
- `page` (optional): Page number (default: 1)
- `limit` (optional): Items per page (default: 20, max: 50)

**Response:**
```json
{
  "success": true,
  "media": [
    {
      "_id": "messageId1",
      "type": "image",
      "content": "Beautiful sunset",
      "mediaInfo": {
        "originalName": "sunset.jpg",
        "mimeType": "image/jpeg",
        "size": 2048000,
        "url": "https://oss.example.com/...",
        "dimensions": { "width": 1920, "height": 1080 },
        "processedImages": [
          {
            "size": "thumbnail",
            "width": 150,
            "height": 150,
            "url": "https://oss.example.com/.../thumb.jpg"
          }
        ]
      },
      "timestamp": "2024-01-01T12:00:00.000Z",
      "sender": {
        "_id": "userId1",
        "name": "John Doe",
        "avatar": "https://..."
      }
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalCount": 95,
    "hasMore": true
  }
}
```

#### Delete Media File
```http
DELETE /api/v1/chat/media/:messageId
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "message": "ลบไฟล์สำเร็จ"
}
```

#### Get Storage Statistics
```http
GET /api/v1/chat/rooms/:chatRoomId/storage-stats
Authorization: Bearer <token>
```

**Response:**
```json
{
  "success": true,
  "stats": {
    "byType": [
      {
        "_id": "image",
        "count": 45,
        "totalSize": 52428800 // bytes
      },
      {
        "_id": "video", 
        "count": 12,
        "totalSize": 157286400
      },
      {
        "_id": "audio",
        "count": 8,
        "totalSize": 25165824
      }
    ],
    "total": {
      "totalFiles": 65,
      "totalSize": 234881024 // ~224MB
    }
  }
}
```

---

## Queue Processing System

### 🎨 Image Processing Jobs

#### Auto-generated Sizes:
- **Thumbnail**: 150x150px (for previews)
- **Medium**: 800x600px (for mobile display)
- **Large**: 1920x1080px (for desktop display)

#### Processing Flow:
```
1. Upload original image to OSS
2. Add to "image_resize" queue
3. Generate multiple sizes using Sharp
4. Upload processed images to OSS
5. Update message with processed URLs
```

### 🎬 Video Processing Jobs

#### Thumbnail Generation:
- Extract frame at 00:00:01
- Create 320x240px thumbnail
- Upload to OSS

#### Video Compression:
- Triggered for files > 50MB
- Target: 1280x720, 1000kbps video, 128kbps audio
- Format: MP4 with H.264/AAC

### 🧹 Cleanup Jobs

#### Automatic Cleanup:
- Remove temporary files after 1 minute
- Clean up failed uploads
- Remove orphaned files

---

## WebSocket Integration

### Real-time Media Updates

#### Media Processing Complete
```javascript
socket.on('media_processed', (data) => {
  console.log('Media processing completed:', data);
  /*
  {
    messageId: 'messageId123',
    type: 'image_resize', // or 'video_thumbnail'
    status: 'completed',
    result: {
      processedImages: [...], // for images
      thumbnailUrl: '...', // for videos
    }
  }
  */
});
```

#### Upload Progress (Future)
```javascript
socket.on('upload_progress', (data) => {
  /*
  {
    messageId: 'messageId123',
    progress: 65, // percentage
    stage: 'uploading' // or 'processing'
  }
  */
});
```

---

## File Storage Structure

### OSS Directory Structure
```
chat-media/
├── {chatRoomId}/
│   ├── original/
│   │   ├── {timestamp}-{randomId}-{index}.{ext}
│   │   └── ...
│   ├── processed/
│   │   ├── {messageId}-thumbnail-{timestamp}.jpg
│   │   ├── {messageId}-medium-{timestamp}.jpg
│   │   └── {messageId}-large-{timestamp}.jpg
│   ├── thumbnails/
│   │   ├── {messageId}-thumb-{timestamp}.jpg (video thumbnails)
│   │   └── ...
│   └── compressed/
│       ├── {messageId}-compressed-{timestamp}.mp4
│       └── ...
```

### File Naming Convention
```
Format: {timestamp}-{randomId}-{index}.{extension}
Example: 1704067200000-abc123def-0.jpg

Where:
- timestamp: Unix timestamp (ms)
- randomId: 9-character random string
- index: File index (for multiple files)
- extension: Original file extension
```

---

## Error Handling

### Common Errors

| Code | Message | Description |
|------|---------|-------------|
| 400 | กรุณาระบุ chatRoomId | Missing chatRoomId in request |
| 400 | ไฟล์มีขนาดใหญ่เกินไป | File exceeds size limit |
| 403 | คุณไม่มีสิทธิ์ส่งข้อความในห้องนี้ | Not a chat room participant |
| 413 | Request entity too large | Total upload size too large |
| 415 | ประเภทไฟล์ไม่รองรับ | Unsupported file type |
| 500 | เกิดข้อผิดพลาดในการอัพโลดไฟล์ | OSS upload failed |

### File Validation Errors
```json
{
  "success": false,
  "message": "Invalid file type",
  "error": "File 'document.exe' is not allowed. Supported types: image/*, video/*, audio/*, application/pdf, text/plain"
}
```

### Size Limit Errors
```json
{
  "success": false,
  "message": "File too large",
  "error": "File 'video.mp4' (150MB) exceeds the 100MB limit for video files"
}
```

---

## Queue Dashboard

### Development Environment
Access the queue dashboard at: `http://localhost:3101/admin/queues`

### Queue Statistics
- **Active Jobs**: Currently processing
- **Waiting Jobs**: In queue
- **Completed Jobs**: Successfully processed
- **Failed Jobs**: Processing failures

### Job Details
- Job ID and timestamp
- Processing duration
- Input parameters
- Output results
- Error messages (if failed)

---

## Performance Considerations

### Upload Optimization
- **Parallel Processing**: Multiple files uploaded simultaneously
- **Chunked Upload**: Large files uploaded in chunks (Future)
- **Client-side Compression**: Reduce upload size (Future)

### Storage Optimization
- **CDN Integration**: Fast global delivery
- **Cache Headers**: 1-year cache for media files
- **Lazy Loading**: Load thumbnails first, full images on demand

### Queue Performance
- **Concurrent Workers**: 5 for image, 3 for video, 2 for compression
- **Job Priorities**: Thumbnails > Resize > Compression
- **Retry Logic**: Exponential backoff for failed jobs

---

## Security Features

### File Validation
- **MIME Type Check**: Server-side validation
- **File Size Limits**: Per-type size restrictions
- **File Extension Check**: Prevent executable uploads
- **Virus Scanning**: Integration ready (Future)

### Access Control
- **Authentication**: JWT token required
- **Authorization**: Chat room membership required
- **File Ownership**: Only sender can delete media
- **Private URLs**: Signed URLs for sensitive content

### Rate Limiting
- **Upload Frequency**: Max 10 files per minute per user
- **Total Size**: Max 500MB per hour per user
- **Queue Limits**: Max 100 pending jobs per user

---

## Integration Examples

### Frontend Upload (React)
```javascript
const uploadMedia = async (chatRoomId, files, message = '') => {
  const formData = new FormData();
  formData.append('chatRoomId', chatRoomId);
  formData.append('content', message);
  
  files.forEach(file => {
    formData.append('files', file);
  });

  try {
    const response = await fetch('/api/v1/chat/messages', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
      body: formData
    });

    const result = await response.json();
    if (result.success) {
      console.log('Upload successful:', result.message);
      // Update UI with new message
    }
  } catch (error) {
    console.error('Upload failed:', error);
  }
};

// Usage
const handleFileUpload = (files) => {
  uploadMedia('chatRoomId123', files, 'Check out these files!');
};
```

### Mobile Upload (Flutter)
```dart
Future<void> uploadMedia(String chatRoomId, List<File> files) async {
  final request = http.MultipartRequest(
    'POST',
    Uri.parse('$baseUrl/api/v1/chat/messages'),
  );
  
  request.headers['Authorization'] = 'Bearer $token';
  request.fields['chatRoomId'] = chatRoomId;
  request.fields['content'] = 'Mobile upload';
  
  for (int i = 0; i < files.length; i++) {
    request.files.add(await http.MultipartFile.fromPath(
      'files',
      files[i].path,
    ));
  }
  
  final response = await request.send();
  final responseBody = await response.stream.bytesToString();
  
  if (response.statusCode == 200) {
    final result = json.decode(responseBody);
    print('Upload successful: ${result['message']}');
  }
}
```

---

## Environment Variables

### Required OSS Configuration
```env
# Alibaba Cloud OSS
OSS_ENDPOINT=https://oss-ap-southeast-1.aliyuncs.com
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET_NAME=your_bucket_name

# Redis (for Queue)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password
```

### Optional Configuration
```env
# Upload Limits
MAX_FILE_SIZE_IMAGE=10485760    # 10MB
MAX_FILE_SIZE_VIDEO=104857600   # 100MB
MAX_FILE_SIZE_AUDIO=52428800    # 50MB
MAX_FILE_SIZE_FILE=26214400     # 25MB

# Queue Settings
QUEUE_CONCURRENCY_IMAGE=5
QUEUE_CONCURRENCY_VIDEO=3
QUEUE_CONCURRENCY_COMPRESS=2
```

---

## Testing

### API Testing with Postman
```bash
# Upload single image
POST /api/v1/chat/messages
Headers: Authorization: Bearer <token>
Body: form-data
  - chatRoomId: "room123"
  - content: "Test image"
  - files: [select image file]

# Get media in room
GET /api/v1/chat/rooms/room123/media?type=image&page=1
Headers: Authorization: Bearer <token>

# Delete media
DELETE /api/v1/chat/media/messageId123
Headers: Authorization: Bearer <token>
```

### Load Testing
```bash
# Install artillery
npm install -g artillery

# Create test script (upload-test.yml)
artillery run upload-test.yml
```

---

## Troubleshooting

### Common Issues

#### 1. OSS Upload Fails
```
Error: Failed to upload file to OSS: RequestTimeout
```
**Solution**: Check OSS credentials and network connectivity

#### 2. Queue Jobs Stuck
```
Warning: Job 123 (image_resize) stalled
```
**Solution**: Restart queue workers or check Redis connection

#### 3. File Size Exceeded
```
Error: File too large (150MB > 100MB limit)
```
**Solution**: Implement client-side compression or increase limits

#### 4. MIME Type Rejection
```
Error: Invalid file type 'application/x-executable'
```
**Solution**: Update allowed MIME types in multer configuration

### Monitoring

#### Queue Health Check
```bash
# Check queue status
curl http://localhost:3101/admin/queues

# Monitor Redis
redis-cli monitor
```

#### Storage Usage
```bash
# Check OSS usage
GET /api/v1/chat/rooms/{roomId}/storage-stats
```

---

## Future Enhancements

### Planned Features
- 🎯 **Progressive Upload**: Chunked upload for large files
- 🎯 **Image Optimization**: WebP conversion, EXIF stripping
- 🎯 **Video Streaming**: HLS/DASH support
- 🎯 **AI Processing**: Auto-tagging, content moderation
- 🎯 **Backup System**: Multi-region replication

### Performance Improvements
- **CDN Integration**: CloudFlare/AWS CloudFront
- **Edge Processing**: Resize images at CDN edge
- **Smart Caching**: Predictive thumbnail generation
- **Bandwidth Optimization**: Adaptive quality based on connection

---

## Summary

✅ **Media Upload System พร้อมใช้งาน!**

**Features ที่มี:**
- Multi-file upload (10 files max)
- OSS storage integration
- Queue-based processing
- File validation & security
- Media management APIs
- Storage statistics
- Real-time WebSocket updates
- Development dashboard

**Ready for Production!** 🚀

ระบบ Media Upload นี้พร้อมรองรับการส่งภาพ, วิดีโอ, เสียง และไฟล์ต่างๆ ในระดับ Production พร้อมระบบ Queue สำหรับ background processing ครับ!
